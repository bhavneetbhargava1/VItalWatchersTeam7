<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Analytics</title>
    <!-- Importing Bootswatch Cerulean theme for consistent styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/cerulean/bootstrap.min.css">
    <style>
        /* General styling for content sections and feature boxes */
        .content-section { padding: 2rem 0; }
        .feature-box { padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-box { margin-bottom: 1rem; } /* Styling for the search input box */
        .error-message { color: red; font-size: 1.1rem; text-align: center; } /* Error message styling */
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html"><i class="fas fa-database"></i> TCSS 445 | Assign4</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <!-- Navigation links -->
                    <li class="nav-item"><a class="nav-link" href="employee.html">Employee</a></li>
                    <li class="nav-item"><a class="nav-link active" href="department.html">Department</a></li>
                    <li class="nav-item"><a class="nav-link" href="project.html">Project</a></li>
                    <li class="nav-item"><a class="nav-link" href="worksOn.html">Works On</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content Section -->
    <div class="content-section">
        <div class="container">
            <h2>Department Analytics</h2>

            <!-- Search Box -->
            <!-- Allows filtering of table rows based on input -->
            <div class="search-box">
                <input type="text" id="searchInput" class="form-control" placeholder="Search departments..." onkeyup="filterTable()">
            </div>

            <!-- Collapsible Accordion for Tables -->
            <div class="accordion" id="departmentAccordion">
                <!-- Salary Statistics Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            Salary Statistics
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#departmentAccordion">
                        <div class="accordion-body">
                            <!-- Table for Salary Statistics -->
                            <table class="table table-bordered table-striped" id="salaryStatsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th onclick="sortTable(0, 'salaryStatsTable')">Department</th>
                                        <th onclick="sortTable(1, 'salaryStatsTable')">Average Salary</th>
                                        <th onclick="sortTable(2, 'salaryStatsTable')">Max Salary</th>
                                        <th onclick="sortTable(3, 'salaryStatsTable')">Min Salary</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Employee Count Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            Employee Count
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#departmentAccordion">
                        <div class="accordion-body">
                            <!-- Table for Employee Count -->
                            <table class="table table-bordered table-striped" id="employeeCountTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th onclick="sortTable(0, 'employeeCountTable')">Department</th>
                                        <th onclick="sortTable(1, 'employeeCountTable')">Employee Count</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Projects Per Department Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            Projects Per Department
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#departmentAccordion">
                        <div class="accordion-body">
                            <!-- Table for Projects Per Department -->
                            <table class="table table-bordered table-striped" id="projectsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th onclick="sortTable(0, 'projectsTable')">Department</th>
                                        <th onclick="sortTable(1, 'projectsTable')">Projects</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Budget Analysis Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFour">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                            Budget Analysis
                        </button>
                    </h2>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#departmentAccordion">
                        <div class="accordion-body">
                            <!-- Table for Budget Analysis -->
                            <table class="table table-bordered table-striped" id="budgetTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th onclick="sortTable(0, 'budgetTable')">Department</th>
                                        <th onclick="sortTable(1, 'budgetTable')">Total Salary Cost</th>
                                        <th onclick="sortTable(2, 'budgetTable')">Salary Percentage</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message d-none">Error loading data. Please try again later.</div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="bg-light mt-5 py-3">
        <div class="container text-center">
            <p class="text-muted">TCSS 445 - Database Systems Design Â© 2024</p>
        </div>
    </footer>

    <!-- Import Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /**
         * Fetches data and populates a specified table.
         * @param {string} endpoint - API endpoint to fetch data.
         * @param {string} tableId - ID of the table to populate.
         * @param {Array<string>} columns - List of column keys for the table.
         */
        const fetchAndPopulate = async (endpoint, tableId, columns) => {
            const response = await fetch(endpoint);
            const data = await response.json();
            const tableBody = document.querySelector(`#${tableId} tbody`);
            tableBody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.textContent = row[col] || 'N/A';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        };

        // Event listener for document load
        document.addEventListener('DOMContentLoaded', async () => {
            const errorMessage = document.getElementById('errorMessage');
            try {
                await fetchAndPopulate('/department/salary-stats', 'salaryStatsTable', ['DepartmentName', 'AverageSalary', 'MaxSalary', 'MinSalary']);
                await fetchAndPopulate('/department/employee-count', 'employeeCountTable', ['DepartmentName', 'EmployeeCount']);
                await fetchAndPopulate('/department/projects', 'projectsTable', ['DepartmentName', 'ProjectCount']);
                await fetchAndPopulate('/department/budget', 'budgetTable', ['DepartmentName', 'TotalSalaryCost', 'SalaryPercentage']);
            } catch (err) {
                console.error('Error loading data:', err);
                errorMessage.classList.remove('d-none');
            }
        });

        /**
         * Filters table rows based on search input.
         */
        const filterTable = () => {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const tables = document.querySelectorAll('.table tbody');
            tables.forEach(table => {
                table.querySelectorAll('tr').forEach(row => {
                    const rowText = Array.from(row.children).map(td => td.textContent.toLowerCase()).join(' ');
                    row.style.display = rowText.includes(input) ? '' : 'none';
                });
            });
        };

        /**
         * Sorts a table column alphabetically or numerically.
         * @param {number} columnIndex - Index of the column to sort.
         * @param {string} tableId - ID of the table to sort.
         */
        const sortTable = (columnIndex, tableId) => {
            const table = document.getElementById(tableId);
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const isAscending = table.getAttribute('data-sort') === 'asc';
            rows.sort((a, b) => {
                const valA = a.children[columnIndex].textContent.trim();
                const valB = b.children[columnIndex].textContent.trim();
                return isAscending ? valA.localeCompare(valB) : valB.localeCompare(valA);
            });
            rows.forEach(row => table.querySelector('tbody').appendChild(row));
            table.setAttribute('data-sort', isAscending ? 'desc' : 'asc');
        };
    </script>
</body>
</html>
